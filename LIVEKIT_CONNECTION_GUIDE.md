# LiveKit Connection Architecture Guide

Complete guide for setting up connection points from React frontend to Python agent backend on LiveKit Cloud.

## Table of Contents

1. [Architecture Overview](#architecture-overview)
2. [How LiveKit Works](#how-livekit-works)
3. [Frontend (React) Connection Flow](#frontend-react-connection-flow)
4. [Backend (Python Agent) Setup](#backend-python-agent-setup)
5. [Connection Points & APIs](#connection-points--apis)
6. [Token Generation](#token-generation)
7. [Room Management](#room-management)
8. [Deployment on LiveKit Cloud](#deployment-on-livekit-cloud)

---

## Architecture Overview

```
┌─────────────────────────────────────────────────────────────────┐
│                          LIVEKIT CLOUD                          │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  ┌──────────────────┐          ┌──────────────────────────┐   │
│  │  WebSocket Room  │◄────────►│  Agent Participant      │   │
│  │  (Voice/Video)   │          │  (Python Backend)       │   │
│  └──────┬───────────┘          └──────────────────────────┘   │
│         │                                                       │
│         ├─ Audio Stream (STT, TTS)                             │
│         ├─ Video Stream                                        │
│         └─ Data Channel (Text, Events)                         │
│                                                                 │
│  ┌──────────────────┐                                          │
│  │ User Participant │◄────────► Frontend (React App)          │
│  │ (Browser Client) │                                          │
│  └──────────────────┘                                          │
│                                                                 │
│  ┌──────────────────┐                                          │
│  │  REST API        │◄────────► Backend Token Server          │
│  │  (Token Gen)     │           (Flask/Node.js)               │
│  └──────────────────┘                                          │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

---

## How LiveKit Works

### Core Concepts

**1. LiveKit Server**
- Manages rooms and participants
- Routes audio/video/data between participants
- Runs on LiveKit Cloud or self-hosted
- URL: `wss://voiceagent-46wqrz65.livekit.cloud` (WSS = WebSocket Secure)

**2. Rooms**
- Containers for multi-participant communication
- Each room has a unique name (e.g., `voice_assistant_room_1234`)
- Participants join rooms to communicate
- Rooms are created on-demand (no pre-creation needed)

**3. Participants**
- Users or agents that join a room
- Each has a unique identity within the room
- Can publish audio/video/data
- Can subscribe to other participants' streams

**4. Access Tokens**
- JWT (JSON Web Tokens) signed with API secret
- Contain participant identity, room name, and permissions
- Required for any participant to connect
- Generated by backend with API key/secret
- Typically valid for 15 minutes

**5. Agent**
- Special participant type for AI/automation
- Runs as a Python or Node.js process
- Joins rooms to interact with users
- Can use AI models (LLM, STT, TTS)
- Example: Your `Assistant` class in `agent.py`

---

## Frontend (React) Connection Flow

### Step 1: User Clicks "Start Call"

**File:** `web/components/app/welcome-view.tsx`

```tsx
// User presses button
<button onClick={() => connect()}>Start Call</button>
```

### Step 2: Request Connection Details

**File:** `web/hooks/useConnection.tsx` (Lines 38-67)

```tsx
// Frontend needs:
// 1. LiveKit server URL (e.g., wss://voiceagent-46wqrz65.livekit.cloud)
// 2. Room name (e.g., voice_assistant_room_1234)
// 3. Participant token (JWT signed by backend)

const tokenSource = useMemo(() => {
  // Call backend API to get token + room details
  return TokenSource.custom(async () => {
    const res = await fetch(NEXT_PUBLIC_CONN_DETAILS_ENDPOINT, {
      method: 'POST',
      body: JSON.stringify({
        room_config: {
          agents: [{ agent_name: 'voice-assistant' }]
        }
      })
    });
    return await res.json(); // Returns { serverUrl, roomName, participantToken, participantName }
  });
}, [appConfig]);
```

### Step 3: Backend Generates Token

**File:** `src/web_server.py` (POST `/api/connection-details`)

```python
# Backend receives request from frontend
# It has access to:
# - LIVEKIT_API_KEY (e.g., APIFQHGZSt7LwV6)
# - LIVEKIT_API_SECRET (e.g., 0zf704fvUDHcn...K)
# - LIVEKIT_URL (e.g., wss://voiceagent-46wqrz65.livekit.cloud)

def connection_details():
    # Generate unique identifiers
    participant_identity = f"voice_assistant_user_{uuid.hex()}"
    room_name = f"voice_assistant_room_{uuid.hex()}"

    # Create JWT token with these claims:
    payload = {
        "iss": LIVEKIT_API_KEY,           # Issuer (your API key)
        "sub": participant_identity,      # Subject (who is connecting)
        "name": "user",                   # Display name
        "iat": now,                       # Issued at
        "exp": now + 900,                 # Expires in 15 minutes
        "video": {
            "canPublish": True,           # Can send audio/video
            "canSubscribe": True,         # Can receive audio/video
            "canPublishData": True,       # Can send data messages
            "room": room_name,            # Which room to join
            "roomJoin": True              # Can join room
        }
    }

    # Sign with secret key
    token = jwt.encode(payload, LIVEKIT_API_SECRET, algorithm="HS256")

    # Return to frontend
    return {
        "serverUrl": LIVEKIT_URL,
        "roomName": room_name,
        "participantToken": token,
        "participantName": "user"
    }
```

### Step 4: Frontend Connects to Room

**File:** `web/hooks/useConnection.tsx` (Line 69-71)

```tsx
// Frontend uses token to establish WebSocket connection
const session = useSession(tokenSource, { agentName: 'voice-assistant' });

// LiveKit React SDK handles:
// 1. WebSocket connection to LiveKit server
// 2. Authentication with the token
// 3. Joining the room specified in token
// 4. Setting up audio/video codec negotiation
// 5. Subscribing to agent's media streams
```

### Step 5: WebRTC Connection Established

```
Browser ──[JWT Token]──► LiveKit Server
         ◄─[Validated]──┘

         ──[WebSocket]──► LiveKit Server (WSS)
         ◄─[Room Config]──┘

         ──[SDP Offer]──► Agent (TURN/STUN)
         ◄─[SDP Answer]───┘

         ──[Audio/Video]─► Agent
         ◄─[Audio/Video]──┘
```

---

## Backend (Python Agent) Setup

### Step 1: Initialize Agent

**File:** `src/agent.py`

```python
from livekit.agents import Agent, AgentSession

class Assistant(Agent):
    def __init__(self):
        super().__init__(
            instructions=SYSTEM_PROMPT,
            # Agent will use:
            # - Speech-to-text (Silero)
            # - Language model (OpenAI)
            # - Text-to-speech
        )

# Create agent instance
agent = Assistant()
```

### Step 2: Start Agent Server

**File:** `src/agent.py` (main section)

```python
if __name__ == "__main__":
    # The agent server registers with LiveKit
    cli.run_app(
        agent,
        entry_point=__file__,
        livekit_url=config.get_livekit_url(),      # wss://voiceagent-46wqrz65.livekit.cloud
        livekit_api_key=config.get_livekit_api_key(),
        livekit_api_secret=config.get_livekit_api_secret()
    )
```

### Step 3: Agent Waits for Room Dispatch

When frontend joins a room, LiveKit Cloud **automatically dispatches** the agent:

```
LiveKit Cloud dispatches request → Agent Server receives "entrypoint call"
                                 → Agent boots subprocess
                                 → Agent joins room
                                 → Agent subscribes to user's audio
```

### Step 4: Agent Processes Audio

**Audio Pipeline:**

```
User's Microphone
    ↓ (Audio Stream)
LiveKit Cloud (WSS)
    ↓ (Receives user's audio)
Agent Subprocess (src/agent.py)
    ├─ [STT] Silero Speech-to-Text → Text
    ├─ [LLM] OpenAI GPT-4 → Response
    ├─ [TTS] OpenAI Text-to-Speech → Audio
    └─ Publish back to room
        ↓
LiveKit Cloud (Routes to user)
    ↓ (Audio Stream)
User's Speaker
```

### Step 5: Function Tools / Custom Actions

**File:** `src/agent.py` (Lines 64-150)

```python
@function_tool
async def get_cv_summary(self, _: RunContext) -> str:
    """Get a high-level summary of the person's CV"""
    # Called by agent during conversation
    # Agent decides when to invoke based on context
    result = self.mcp_client.get_cv_summary()
    return result

# Agent can call these tools during conversation:
# - get_cv_summary()
# - search_company_experience(company_name)
# - search_technology_experience(technology)
# - search_education(institution, degree)
# - search_skills(category)
# - search_publications(year)
```

---

## Connection Points & APIs

### 1. Frontend → Backend (HTTP/REST)

**Endpoint:** `POST /api/connection-details`

**Request:**
```json
{
  "room_config": {
    "agents": [{ "agent_name": "voice-assistant" }]
  }
}
```

**Response:**
```json
{
  "serverUrl": "wss://voiceagent-46wqrz65.livekit.cloud",
  "roomName": "voice_assistant_room_abc123",
  "participantToken": "eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9...",
  "participantName": "user"
}
```

**Implementation:**
- **Frontend:** `web/hooks/useConnection.tsx:40-58`
- **Backend (Flask):** `src/web_server.py:43-100`
- **Backend (Next.js API):** `web/app/api/connection-details/route.ts`

### 2. Frontend ↔ LiveKit Cloud (WebSocket)

**Connection URL:** `wss://voiceagent-46wqrz65.livekit.cloud`

**Protocol:** LiveKit RTC Protocol over WebSocket

**Data Exchange:**
- Audio frames (opus codec)
- Video frames (VP8/H.264)
- Data messages
- Connection state updates

**Implementation:**
- **SDK:** `@livekit/components-react` (React component library)
- **Client:** `livekit-client` (JS SDK)

### 3. Agent ↔ LiveKit Cloud (WebRTC)

**Connection:** Direct WebRTC peer connection

**Data Exchange:**
- Audio frames (receives user audio, sends processed audio)
- Metadata
- Custom data messages

**Implementation:**
- **SDK:** `livekit.agents` (Python agent framework)
- **Plugins:**
  - `livekit.plugins.silero` (STT)
  - `livekit.plugins.openai` (LLM, TTS)

### 4. Backend ↔ External Services

**LLM:** OpenAI API
```python
from livekit.plugins import openai
llm = openai.LLM(model="gpt-4")
```

**Vector DB:** Qdrant
```python
from qdrant_client import QdrantClient
vector_db = QdrantClient(url="https://kasioss.com:6333")
```

**Database:** PostgreSQL
```python
import psycopg2
db = psycopg2.connect("postgresql://...")
```

**MCP Server:** Custom tools for data retrieval
```python
from mcp_client import get_mcp_client
mcp = get_mcp_client()
mcp.get_cv_summary()
```

---

## Token Generation

### What is a LiveKit Token?

A JWT (JSON Web Token) that authenticates a participant to connect to LiveKit.

### Token Structure

```
Header:
{
  "typ": "JWT",
  "alg": "HS256"
}

Payload:
{
  "iss": "APIFQHGZSt7LwV6",                    // Your API Key
  "sub": "voice_assistant_user_abc123",       // Participant identity
  "name": "user",                             // Display name
  "iat": 1700000000,                          // Issued at (unix time)
  "exp": 1700000900,                          // Expires at (15 min later)
  "video": {
    "canPublish": true,
    "canSubscribe": true,
    "canPublishData": true,
    "room": "voice_assistant_room_abc123",
    "roomJoin": true
  }
}

Signature: HMAC-SHA256(encoded_header + "." + encoded_payload, API_SECRET)
```

### Token Lifespan

- **Issue time:** When user clicks "Start Call"
- **Valid for:** 15 minutes
- **Automatic refresh:** LiveKit SDK refreshes tokens as needed
- **Revocation:** API key revocation invalidates all tokens

### Security Best Practices

✅ **DO:**
- Generate tokens on backend (never in frontend)
- Use unique participant identities
- Set appropriate TTL (15 minutes is good default)
- Validate user authentication before issuing token
- Use HTTPS for token distribution

❌ **DON'T:**
- Hardcode API secret in frontend
- Share API secret publicly
- Generate tokens with infinite expiration
- Use same token for multiple users
- Log tokens

---

## Room Management

### Room Creation

Rooms are **created automatically** when:
1. First participant joins with valid token
2. Token specifies `room: "room_name"`

```python
# No explicit room creation needed!
# Just generate token with room name
payload = {
    "video": {
        "room": "voice_assistant_room_abc123"
    }
}
```

### Room Lifecycle

```
1. [Room Created]
   ↓ (When first participant joins)

2. [Participants Joined]
   ├─ User (browser client)
   ├─ Agent (Python process)
   ├─ Optional: Other participants

3. [Active]
   ├─ Audio/video flowing
   ├─ Agent processing user input

4. [User Leaves]
   ├─ Frontend disconnects
   ├─ Agent may continue processing

5. [Agent Leaves]
   ├─ No more active participants

6. [Room Deleted]
   ├─ Deleted after inactivity (usually 5-15 min)
   ├─ Can be manually deleted via API
```

### Managing Multiple Rooms

Each conversation gets a unique room:

```python
# Backend generates unique room name
def connection_details():
    room_name = f"voice_assistant_room_{secrets.token_hex(8)}"
    # This ensures each user gets isolated room
    # Agent joins and handles that specific room
```

### Room Cleanup

Rooms are automatically deleted when:
- All participants leave
- No activity for configurable period (default: 5 minutes)

Manual cleanup via API:
```python
from livekit.api import RoomServiceClient

room_service = RoomServiceClient(
    url=LIVEKIT_URL,
    api_key=LIVEKIT_API_KEY,
    api_secret=LIVEKIT_API_SECRET
)

# Delete a room
room_service.delete_room("voice_assistant_room_abc123")

# List all rooms
rooms = room_service.list_rooms()

# List participants in room
participants = room_service.list_participants("voice_assistant_room_abc123")
```

---

## Deployment on LiveKit Cloud

### Configuration

**LiveKit Cloud Credentials:**

1. **LIVEKIT_URL** (Server URL)
   - Format: `wss://subdomain.livekit.cloud`
   - Example: `wss://voiceagent-46wqrz65.livekit.cloud`
   - Get from: LiveKit Cloud console → Project → Copy Webhook URL

2. **LIVEKIT_API_KEY** (Authentication)
   - Format: String like `APIFQHGZSt7LwV6`
   - Get from: LiveKit Cloud console → Project → API Credentials

3. **LIVEKIT_API_SECRET** (Signing Key)
   - Format: Long hex string like `0zf704fvUDHcnAxexg7wayzycMyE4UKpGiPjEGf2niDB`
   - Get from: LiveKit Cloud console → Project → API Credentials
   - **⚠️ KEEP PRIVATE** - Never commit to git or expose to frontend

### Environment Setup

**Backend (.env.local):**
```env
LIVEKIT_URL=wss://voiceagent-46wqrz65.livekit.cloud
LIVEKIT_API_KEY=APIFQHGZSt7LwV6
LIVEKIT_API_SECRET=0zf704fvUDHcnAxexg7wayzycMyE4UKpGiPjEGf2niDB
```

**Frontend (.env.local):**
```env
NEXT_PUBLIC_LIVEKIT_URL=wss://voiceagent-46wqrz65.livekit.cloud
NEXT_PUBLIC_CONN_DETAILS_ENDPOINT=http://localhost:8019/api/connection-details
```

**Frontend (Production on Render.com):**
```env
NEXT_PUBLIC_LIVEKIT_URL=wss://voiceagent-46wqrz65.livekit.cloud
NEXT_PUBLIC_CONN_DETAILS_ENDPOINT=https://your-backend-url.com/api/connection-details
```

### Agent Deployment

**Option 1: Local Development**
```bash
# Terminal 1: Start agent
python -m livekit.agents.cli run_app src.agent:agent

# Terminal 2: Start backend
python src/agent.py

# Terminal 3: Start frontend
cd web && pnpm dev
```

**Option 2: Docker Deployment (Backend)**
```bash
# Dockerfile for agent
docker build -t ptee-agent:latest .
docker run -e LIVEKIT_URL=wss://... \
           -e LIVEKIT_API_KEY=... \
           -e LIVEKIT_API_SECRET=... \
           ptee-agent:latest
```

**Option 3: LiveKit Cloud Worker Deployment**
```bash
# Via LiveKit Cloud console
# Upload agent image → Auto-scales with demand
```

### Frontend Deployment

See `web/DOCKER.md` and `web/CLAUDE.md` for:
- Docker deployment
- Render.com deployment
- Vercel deployment

---

## Complete Data Flow Example

### Scenario: User asks "What was my first job?"

```
1. USER CLICKS START CALL
   └─ web/components/app/welcome-view.tsx

2. FRONTEND REQUESTS CONNECTION DETAILS
   └─ POST http://localhost:8019/api/connection-details
      Body: { room_config: { agents: [{ agent_name: "voice-assistant" }] } }

3. BACKEND GENERATES TOKEN
   └─ src/web_server.py::connection_details()
      Creates JWT with:
      - Participant identity: voice_assistant_user_xyz123
      - Room name: voice_assistant_room_xyz123
      - Permissions: publish, subscribe, publishData
      Returns: { serverUrl, roomName, participantToken, participantName }

4. FRONTEND CONNECTS TO LIVEKIT
   └─ web/hooks/useConnection.tsx
      - Establishes WSS connection to wss://voiceagent-46wqrz65.livekit.cloud
      - Authenticates with JWT token
      - Joins room: voice_assistant_room_xyz123

5. LIVEKIT DISPATCHES AGENT
   └─ LiveKit Cloud auto-detects agent subscription
      Calls: Agent's entry point (src/agent.py::on_participant_connect)

6. AGENT SUBPROCESS STARTS
   └─ src/agent.py::Assistant.on_prewarm_request()
      Initializes:
      - Speech-to-text (Silero)
      - Language model (OpenAI)
      - Text-to-speech (OpenAI)

7. AGENT JOINS ROOM
   └─ Connects via LiveKit SDK
      Joins same room: voice_assistant_room_xyz123
      Now has bidirectional audio with user

8. USER SPEAKS INTO MICROPHONE
   └─ Browser captures audio
      Sends audio frames → LiveKit Cloud
      LiveKit routes → Agent subprocess

9. AGENT PROCESSES AUDIO
   └─ src/agent.py::Assistant.on_message()
      ├─ STT: Silero converts audio → text
      │  "What was my first job?"
      ├─ LLM: OpenAI processes text
      │  - System prompt loaded (src/prompts.py)
      │  - Context from MCP tools
      │  - Tool invocation: search_company_experience()
      ├─ MCP Client calls tool
      │  └─ src/mcp_client.py::search_company_experience()
      │     Queries Qdrant vector DB → Finds first job
      │     Returns: { status: "success", results: [...] }
      ├─ LLM generates response
      │  "Your first job was at Company X in 2015"
      └─ TTS: OpenAI converts response → audio

10. AGENT PUBLISHES RESPONSE
    └─ Sends audio frames → LiveKit Cloud
       LiveKit routes → Browser

11. USER HEARS RESPONSE
    └─ Browser plays audio through speakers

12. CONVERSATION CONTINUES
    └─ Same flow for additional exchanges

13. USER CLICKS END CALL
    └─ Frontend disconnects from room
       Agent subprocess still running (can handle other rooms)
       Room is cleaned up after inactivity

14. ROOM DELETED
    └─ LiveKit automatically deletes room
       All state cleared
```

---

## Troubleshooting Connection Issues

### Frontend Can't Connect

```
Error: "Error fetching connection details"
↓
Check:
1. Backend is running (nc -zv localhost 8019)
2. NEXT_PUBLIC_CONN_DETAILS_ENDPOINT is correct
3. Backend returned valid response: { serverUrl, roomName, participantToken }
4. Token is not expired
5. CORS enabled on backend (check: CORS(app, resources={r"/api/*": {"origins": "*"}}))
```

### Agent Not Joining Room

```
Error: Agent not detected in room
↓
Check:
1. LiveKit credentials correct (LIVEKIT_API_KEY, LIVEKIT_API_SECRET)
2. Agent subprocess is running
3. Logs: `tail -f logs/agent.log`
4. Room exists: LiveKit Dashboard → Rooms
5. Agent permission: token must have { agents: [{ agentName: "voice-assistant" }] }
```

### No Audio Flowing

```
Error: One-way audio or no audio
↓
Check:
1. Microphone permissions (browser settings)
2. Microphone selected in browser
3. Agent audio enabled: `agent.publish_audio()`
4. Codec support: VP8 video, Opus audio
5. Network: Firewall allowing UDP 10000-20000
6. Firewall rules in LiveKit Cloud console
```

### Token Expired

```
Error: "401 Unauthorized" or connection drops after 15 minutes
↓
Check:
1. Token TTL: Should be 15 minutes minimum
2. Token refresh: SDK should auto-refresh (check network tab)
3. Token issuer: Must match LIVEKIT_API_KEY
4. Signature: Must be signed with LIVEKIT_API_SECRET
```

---

## Resources

- **LiveKit Docs:** https://docs.livekit.io/
- **Agent Framework:** https://docs.livekit.io/agents
- **JavaScript SDK:** https://docs.livekit.io/sdks/client-sdk-js
- **Python SDK:** https://docs.livekit.io/sdks/server-sdk-python
- **Agent Docs:** https://docs.livekit.io/agents/voice-ai-quickstart
- **Your Project:**
  - Frontend: `/web/CLAUDE.md`
  - Backend: `/src/agent.py`
  - Connection: `/web/hooks/useConnection.tsx`

---

**Last Updated:** November 2024
**Project:** ptee-voice-agent
**Version:** 1.0
